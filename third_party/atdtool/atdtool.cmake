# =========== third_party atdtool ==================

set(PROJECT_THIRD_PARTY_ATDTOOL_VERSION "1.0.3")
set(PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR
    "${PROJECT_THIRD_PARTY_PACKAGE_DIR}/atdtool-v${PROJECT_THIRD_PARTY_ATDTOOL_VERSION}")

if(NOT PROJECT_THIRD_PARTY_ATDTOOL_RELEASE_MIRROR)
  set(PROJECT_THIRD_PARTY_ATDTOOL_RELEASE_MIRROR "https://github.com/atframework/atdtool/releases/download")
endif()

if(EXISTS "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/version")
  file(READ "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/version" PROJECT_THIRD_PARTY_ATDTOOL_EXISTED_VERSION)
else()
  set(PROJECT_THIRD_PARTY_ATDTOOL_EXISTED_VERSION "")
endif()

if(CMAKE_SYSTEM_NAME STREQUAL "Windows")
  set(PROJECT_THIRD_PARTY_ATDTOOL_PREBUILT_FILES "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/windows/bin/atdtool.exe")
elseif(CMAKE_SYSTEM_NAME STREQUAL "Darwin")
  set(PROJECT_THIRD_PARTY_ATDTOOL_PREBUILT_FILES "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/darwin/bin/atdtool")
else()
  set(PROJECT_THIRD_PARTY_ATDTOOL_PREBUILT_FILES "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/linux/bin/atdtool")
endif()

set(PROJECT_THIRD_PARTY_ATDTOOL_NEED_DOWNLOAD FALSE)
foreach(PROJECT_THIRD_PARTY_ATDTOOL_CHECK_FILE IN LISTS PROJECT_THIRD_PARTY_ATDTOOL_PREBUILT_FILES)
  if(NOT EXISTS "${PROJECT_THIRD_PARTY_ATDTOOL_CHECK_FILE}")
    set(PROJECT_THIRD_PARTY_ATDTOOL_NEED_DOWNLOAD TRUE)
    break()
  endif()
endforeach()

if(PROJECT_THIRD_PARTY_ATDTOOL_NEED_DOWNLOAD OR NOT PROJECT_THIRD_PARTY_ATDTOOL_EXISTED_VERSION STREQUAL
                                              PROJECT_THIRD_PARTY_ATDTOOL_VERSION)
  file(MAKE_DIRECTORY "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}")
  if(CMAKE_SYSTEM_NAME STREQUAL "Windows")
    findconfigurepackagedownloadfile(
      "${PROJECT_THIRD_PARTY_ATDTOOL_RELEASE_MIRROR}/v${PROJECT_THIRD_PARTY_ATDTOOL_VERSION}/atdtool-windows-amd64.zip"
      "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/atdtool_windows_amd64.zip")
    file(MAKE_DIRECTORY "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/windows")
    findconfigurepackageunzip("${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/atdtool_windows_amd64.zip"
                              "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/windows/")
  elseif(CMAKE_SYSTEM_NAME STREQUAL "Darwin")
    findconfigurepackagedownloadfile(
      "${PROJECT_THIRD_PARTY_ATDTOOL_RELEASE_MIRROR}/v${PROJECT_THIRD_PARTY_ATDTOOL_VERSION}/atdtool-darwin-amd64.tar.gz"
      "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/atdtool_darwin_amd64.tar.gz")
    file(MAKE_DIRECTORY "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/darwin")
    findconfigurepackagetarxv("${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/atdtool_darwin_amd64.tar.gz"
                            "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/darwin/")
  else()
    findconfigurepackagedownloadfile(
      "${PROJECT_THIRD_PARTY_ATDTOOL_RELEASE_MIRROR}/v${PROJECT_THIRD_PARTY_ATDTOOL_VERSION}/atdtool-linux-amd64.tar.gz"
      "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/atdtool_linux_amd64.tar.gz")
    file(MAKE_DIRECTORY "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/linux")
    findconfigurepackagetarxv("${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/atdtool_linux_amd64.tar.gz"
                            "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/linux/")
  endif()

  foreach(PROJECT_THIRD_PARTY_ATDTOOL_CHECK_FILE IN LISTS PROJECT_THIRD_PARTY_ATDTOOL_PREBUILT_FILES)
    if(NOT EXISTS "${PROJECT_THIRD_PARTY_ATDTOOL_CHECK_FILE}")
      message(FATAL_ERROR "Failed to download atdtool into ${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}")
    endif()
  endforeach()

  project_make_executable(${PROJECT_THIRD_PARTY_ATDTOOL_PREBUILT_FILES})
  file(WRITE "${PROJECT_THIRD_PARTY_ATDTOOL_PACKAGE_DIR}/version" "${PROJECT_THIRD_PARTY_ATDTOOL_VERSION}")
endif()
